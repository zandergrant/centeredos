<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centered - Your Daily Pulse</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Welcome</h1>
        <p>Your centeredness journey continues.</p>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <p style="font-size: 0.8em; color: #555; margin: 0;">Status: <span id="auth-status">Connecting...</span></p>
            <button id="signout-btn" class="hidden" style="padding: 5px 10px;">Sign Out</button>
        </div>
    </header>

    <div id="auth-container" style="margin-top: 20px;">
        <form id="login-form">
            <h3>Login</h3>
            <input type="email" id="login-email" placeholder="Email" required><br><br>
            <input type="password" id="login-password" placeholder="Password" required><br><br>
            <button type="submit">Login</button>
        </form>
        <form id="signup-form" class="hidden" style="margin-top: 20px;">
            <h3>Sign Up</h3>
            <input type="email" id="signup-email" placeholder="Email" required><br><br>
            <input type="password" id="signup-password" placeholder="Password" required><br><br>
            <button type="submit">Sign Up</button>
        </form>
        <p><a href="#" id="toggle-form-link">Need an account? Sign Up</a></p>
    </div>

    <main id="app-content" class="hidden">
        <button id="open-pulse-btn">Open Daily Pulse</button>
        </main>
    
    <div id="pulse-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <h2 id="modal-title">Daily Pulse Check-in</h2>
            <form id="pulse-form">
                <div class="slider-group">
                    <label for="steadiness">How steady do you feel right now?</label>
                    <input type="range" id="steadiness" name="steadiness" min="0" max="10" value="5">
                    <span class="slider-value">5</span>
                </div>
                <div class="slider-group">
                    <label for="presence">How present were you today?</label>
                    <input type="range" id="presence" name="presence" min="0" max="10" value="5">
                    <span class="slider-value">5</span>
                </div>
                <div class="slider-group">
                    <label for="connection">How connected vs. reactive did you feel?</label>
                    <input type="range" id="connection" name="connection" min="0" max="10" value="5">
                    <span class="slider-value">5</span>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn-primary">Submit</button>
                    <button type="button" id="skip-now-btn">Skip for now</button>
                    <button type="button" id="skip-today-btn">Skip for today</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAkF3nGHsrotcmT1Fen8Kujdlq5JIrqllk",
            authDomain: "centeredos.firebaseapp.com",
            projectId: "centeredos",
            storageBucket: "centeredos.firebasestorage.app",
            messagingSenderId: "129785779353",
            appId: "1:129785779353:web:f0c24b16f5e83e6f5c9408",
            measurementId: "G-7S84S0NHQV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;

        // --- Get all the HTML elements we need ---
        const authStatus = document.getElementById('auth-status');
        const authContainer = document.getElementById('auth-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const toggleFormLink = document.getElementById('toggle-form-link');
        const appContent = document.getElementById('app-content');
        const signoutBtn = document.getElementById('signout-btn');

        // --- Handle User Authentication State ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in.
                currentUserId = user.uid;
                authStatus.textContent = `Connected (${user.email})`;
                authContainer.classList.add('hidden');
                appContent.classList.remove('hidden');
                signoutBtn.classList.remove('hidden');
            } else {
                // User is signed out.
                currentUserId = null;
                authStatus.textContent = 'Not connected';
                authContainer.classList.remove('hidden');
                appContent.classList.add('hidden');
                signoutBtn.classList.add('hidden');
            }
        });
        
        // --- Form Toggle Logic ---
        toggleFormLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (signupForm.classList.contains('hidden')) {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                toggleFormLink.textContent = 'Already have an account? Login';
            } else {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                toggleFormLink.textContent = 'Need an account? Sign Up';
            }
        });

        // --- Handle Sign Up ---
        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            createUserWithEmailAndPassword(auth, email, password)
                .then(userCredential => console.log('Signed up:', userCredential.user))
                .catch(error => alert(error.message));
        });

        // --- Handle Login ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, email, password)
                .then(userCredential => console.log('Logged in:', userCredential.user))
                .catch(error => alert(error.message));
        });

        // --- Handle Sign Out ---
        signoutBtn.addEventListener('click', () => {
            signOut(auth).catch(error => console.error('Sign out error', error));
        });


        // --- Get Modal elements ---
        const modal = document.getElementById('pulse-modal');
        const openBtn = document.getElementById('open-pulse-btn');
        const pulseForm = document.getElementById('pulse-form');
        const skipNowBtn = document.getElementById('skip-now-btn');
        const skipTodayBtn = document.getElementById('skip-today-btn');

        function showModal() { modal.classList.remove('hidden'); }
        function hideModal() { modal.classList.add('hidden'); }
        
        openBtn.addEventListener('click', showModal);

        // --- Get YYYY-MM-DD date string ---
        function getFormattedDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // --- Event listener for the "Submit" button ---
        pulseForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!currentUserId) {
                alert("You must be logged in to submit a pulse check.");
                return;
            }

            const formData = new FormData(pulseForm);
            const pulseData = {
                steadiness: parseInt(formData.get('steadiness'), 10),
                presence: parseInt(formData.get('presence'), 10),
                connection: parseInt(formData.get('connection'), 10),
                status: 'completed',
                submittedAt: new Date().toISOString()
            };

            const docId = `${currentUserId}_${getFormattedDate()}`;
            
            try {
                await setDoc(doc(db, "pulseCheckins", docId), pulseData);
                hideModal();
            } catch (error) {
                console.error("Error writing document: ", error);
                alert("Could not save your pulse check. Please try again.");
            }
        });

        // --- Event listener for the "Skip for now" button ---
        skipNowBtn.addEventListener('click', () => {
            const tenMinutesFromNow = new Date().getTime() + (10 * 60 * 1000);
            localStorage.setItem('snoozeUntil', tenMinutesFromNow);
            hideModal();
        });

        // --- Event listener for the "Skip for today" button ---
        skipTodayBtn.addEventListener('click', async () => {
            if (!currentUserId) {
                alert("You must be logged in to skip.");
                return;
            }

            const docId = `${currentUserId}_${getFormattedDate()}`;

            try {
                await setDoc(doc(db, "pulseCheckins", docId), {
                    status: 'skipped',
                    submittedAt: new Date().toISOString()
                });
                hideModal();
            } catch (error) {
                console.error("Error writing skipped document: ", error);
                alert("Could not save your choice. Please try again.");
            }
        });

        // --- Logic to update the number display next to each slider ---
        const sliders = document.querySelectorAll('.slider-group input[type="range"]');
        sliders.forEach(slider => {
            const valueSpan = slider.nextElementSibling;
            slider.addEventListener('input', (e) => {
                valueSpan.textContent = e.target.value;
            });
        });

    </script>
</body>
</html>
