<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centered - Your Daily Pulse</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <h1>Welcome</h1>
        <div class="header-controls">
            <p>Status: <span id="auth-status">Connecting...</span></p>
            <button id="signout-btn" class="hidden">Sign Out</button>
        </div>
    </header>

    <div id="auth-container">
        <form id="login-form"><h3>Login</h3><input type="email" id="login-email" placeholder="Email" required><br><br><input type="password" id="login-password" placeholder="Password" required><br><br><button type="submit">Login</button></form><form id="signup-form" class="hidden"><h3>Sign Up</h3><input type="email" id="signup-email" placeholder="Email" required><br><br><input type="password" id="signup-password" placeholder="Password" required><br><br><button type="submit">Sign Up</button></form><p><a href="#" id="toggle-form-link">Need an account? Sign Up</a></p>
    </div>

    <main id="app-content" class="hidden">
        <div id="dashboard">
            <!-- Tile 1: Centeredness Graph -->
            <div class="tile full-width">
                <div class="tile-header">
                    <h3>Centeredness</h3>
                    <div class="chart-controls">
                        <button id="chart-today-btn">Today</button>
                        <button id="chart-7d-btn" class="active">7D</button>
                        <button id="chart-30d-btn">30D</button>
                    </div>
                </div>
                <div class="tile-content chart-container">
                    <canvas id="centeredness-chart"></canvas>
                    <div id="chart-no-data" class="hidden">Not enough data to display</div>
                </div>
                <div class="tile-footer">
                    <button id="pulse-action-btn" class="btn-primary">Do Today's Pulse Check</button>
                </div>
            </div>

            <!-- Tile 2: Daily Reflection -->
            <div class="tile full-width" id="reflection-tile">
                <div class="tile-header">
                    <h3>Daily Reflection</h3>
                    <div class="date-nav">
                        <button id="prev-day-btn">&lt;</button>
                        <span id="reflection-date-display"></span>
                        <button id="next-day-btn">&gt;</button>
                    </div>
                </div>
                <div class="tile-content">
                    <p id="ai-prompt-display">Loading your daily prompt...</p>
                    <textarea id="reflection-entry" placeholder="Write your reflection here..."></textarea>
                </div>
                <div class="tile-footer">
                    <button id="submit-reflection-btn">Save Reflection</button>
                </div>
            </div>
        </div>
    </main>
    
    <div id="pulse-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title"><div class="modal-content"><h2 id="modal-title">Daily Pulse Check-in</h2><form id="pulse-form"><div class="slider-group"><label for="steadiness">How steady do you feel right now?</label><input type="range" id="steadiness" name="steadiness" min="0" max="10" value="5"><span class="slider-value">5</span></div><div class="slider-group"><label for="presence">How present were you today?</label><input type="range" id="presence" name="presence" min="0" max="10" value="5"><span class="slider-value">5</span></div><div class="slider-group"><label for="connection">How connected vs. reactive did you feel?</label><input type="range" id="connection" name="connection" min="0" max="10" value="5"><span class="slider-value">5</span></div><div class="button-group"><button type="submit" class="btn-primary">Submit</button><button type="button" id="skip-now-btn">Skip for now</button><button type="button" id="skip-today-btn">Skip for today</button></div></form></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAkF3nGHsrotcmT1Fen8Kujdlq5JIrqllk", authDomain: "centeredos.firebaseapp.com", projectId: "centeredos", storageBucket: "centeredos.firebasestorage.app", messagingSenderId: "129785779353", appId: "1:129785779353:web:f0c24b16f5e83e6f5c9408", measurementId: "G-7S84S0NHQV" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;
        let centerednessChart = null;
        let reflectionDate = new Date();
        let currentChartTimeframe = 7; 

        const authContainer = document.getElementById('auth-container');
        const appContent = document.getElementById('app-content');
        const signoutBtn = document.getElementById('signout-btn');
        const authStatus = document.getElementById('auth-status');
        const modal = document.getElementById('pulse-modal');
        const pulseActionBtn = document.getElementById('pulse-action-btn');
        const aiPromptDisplay = document.getElementById('ai-prompt-display');
        const reflectionEntry = document.getElementById('reflection-entry');
        const submitReflectionBtn = document.getElementById('submit-reflection-btn');
        const prevDayBtn = document.getElementById('prev-day-btn');
        const nextDayBtn = document.getElementById('next-day-btn');
        const reflectionDateDisplay = document.getElementById('reflection-date-display');
        const chartCanvas = document.getElementById('centeredness-chart');
        const chartNoData = document.getElementById('chart-no-data');
        const chartTodayBtn = document.getElementById('chart-today-btn');
        const chart7dBtn = document.getElementById('chart-7d-btn');
        const chart30dBtn = document.getElementById('chart-30d-btn');

        function getFormattedDate(date) { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }

        function createOrUpdateChart(chartData, chartType) {
            const ctx = chartCanvas.getContext('2d');
            if (centerednessChart) centerednessChart.destroy();

            let config;
            if (chartType === 'bar') {
                const data = chartData[0] || { steadiness: 0, presence: 0, connection: 0 };
                config = {
                    type: 'bar',
                    data: {
                        labels: ['Steadiness', 'Presence', 'Connection'],
                        datasets: [{
                            label: 'Today\'s Scores',
                            data: [data.steadiness, data.presence, data.connection],
                            backgroundColor: ['rgba(75, 192, 192, 0.2)', 'rgba(255, 159, 64, 0.2)', 'rgba(153, 102, 255, 0.2)'],
                            borderColor: ['rgb(75, 192, 192)', 'rgb(255, 159, 64)', 'rgb(153, 102, 255)'],
                            borderWidth: 1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true, max: 10 } }, plugins: { legend: { display: false } } }
                };
            } else { 
                config = {
                    type: 'line',
                    data: {
                        labels: chartData.map(d => new Date(d.dateStr + 'T00:00:00').toLocaleDateString('en-us', { month: 'short', day: 'numeric' })),
                        datasets: [
                            { label: 'Steadiness', data: chartData.map(d => d.steadiness), borderColor: 'rgb(75, 192, 192)', tension: 0.1 },
                            { label: 'Presence', data: chartData.map(d => d.presence), borderColor: 'rgb(255, 159, 64)', tension: 0.1 },
                            { label: 'Connection', data: chartData.map(d => d.connection), borderColor: 'rgb(153, 102, 255)', tension: 0.1 }
                        ]
                    },
                    options: { scales: { y: { beginAtZero: true, max: 10 } } }
                };
            }
            centerednessChart = new Chart(ctx, config);
        }

        async function loadPulseData() {
            let chartData = [];
            const daysToFetch = currentChartTimeframe;
            for (let i = daysToFetch - 1; i >= 0; i--) {
                const date = new Date(); date.setDate(date.getDate() - i); const dateStr = getFormattedDate(date);
                const docSnap = await getDoc(doc(db, "pulseCheckins", `${currentUserId}_${dateStr}`));
                if (docSnap.exists() && docSnap.data().status === 'completed') chartData.push({ dateStr, ...docSnap.data() });
            }

            if (chartData.length === 0) {
                chartCanvas.classList.add('hidden');
                chartNoData.classList.remove('hidden');
            } else {
                chartCanvas.classList.remove('hidden');
                chartNoData.classList.add('hidden');
                createOrUpdateChart(chartData, currentChartTimeframe === 1 ? 'bar' : 'line');
            }
            
            const todayDocSnap = await getDoc(doc(db, "pulseCheckins", `${currentUserId}_${getFormattedDate(new Date())}`));
            if (todayDocSnap.exists()) {
                pulseActionBtn.textContent = "Today's Pulse Submitted"; pulseActionBtn.disabled = true;
            } else {
                pulseActionBtn.textContent = "Do Today's Pulse Check"; pulseActionBtn.disabled = false;
            }
        }

        async function loadReflectionData(date) {
            const dateStr = getFormattedDate(date);
            reflectionDateDisplay.textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            nextDayBtn.disabled = dateStr === getFormattedDate(new Date());

            const docSnap = await getDoc(doc(db, "reflections", `${currentUserId}_${dateStr}`));
            if (docSnap.exists()) {
                aiPromptDisplay.textContent = docSnap.data().promptText || "Welcome! Write your reflection below.";
                reflectionEntry.value = docSnap.data().entryText || '';
                reflectionEntry.classList.remove('hidden');
                submitReflectionBtn.classList.remove('hidden');
                reflectionEntry.disabled = false;
                submitReflectionBtn.disabled = false;
            } else {
                reflectionEntry.value = '';
                if (dateStr === getFormattedDate(new Date())) {
                    // Temporarily disable controls to prevent race condition
                    reflectionEntry.disabled = true;
                    submitReflectionBtn.disabled = true;
                    generateAIPrompt(date);
                } else {
                    aiPromptDisplay.textContent = "No reflection recorded for this day.";
                    reflectionEntry.classList.add('hidden');
                    submitReflectionBtn.classList.add('hidden');
                }
            }
        }

        async function generateAIPrompt(date) {
            aiPromptDisplay.textContent = "Thinking of a good prompt for you...";
            const q = query(collection(db, "reflections"), where("userId", "==", currentUserId), orderBy("submittedAt", "desc"), limit(5));
            const querySnapshot = await getDocs(q);
            let pastReflections = [];
            querySnapshot.forEach(doc => { if (doc.data().entryText) pastReflections.push(doc.data().entryText); });
            
            const systemPrompt = "You are a thoughtful journal assistant. Your goal is to provide a concise (under 180 characters) and insightful CBT-based prompt. If the user has past reflections, base your prompt on their recent themes. Otherwise, provide a general CBT prompt about thoughts, feelings, or behaviors.";
            let userQuery = "Please generate a new journal prompt for me.";
            if (pastReflections.length > 0) userQuery += "\n\nHere are my most recent reflections:\n- " + pastReflections.join('\n- ');
            
            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                const newPrompt = result.candidates[0].content.parts[0].text;

                aiPromptDisplay.textContent = newPrompt;
                await setDoc(doc(db, "reflections", `${currentUserId}_${getFormattedDate(date)}`), { promptText: newPrompt, entryText: '', userId: currentUserId, submittedAt: new Date(date).toISOString() });
            } catch (error) {
                console.error("AI Prompt generation failed:", error);
                aiPromptDisplay.textContent = "What is one thought you've had today that you'd like to look at more closely?";
            } finally {
                reflectionEntry.classList.remove('hidden'); 
                submitReflectionBtn.classList.remove('hidden'); 
                reflectionEntry.disabled = false;
                submitReflectionBtn.disabled = false;
            }
        }
        
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid; authStatus.textContent = `Connected (${user.email})`;
                authContainer.classList.add('hidden'); appContent.classList.remove('hidden'); signoutBtn.classList.remove('hidden');
                loadPulseData(); loadReflectionData(reflectionDate);
                const isSnoozed = localStorage.getItem('snoozeUntil') && new Date().getTime() < parseInt(localStorage.getItem('snoozeUntil'), 10);
                getDoc(doc(db, "pulseCheckins", `${currentUserId}_${getFormattedDate(new Date())}`)).then(docSnap => {
                    if (!docSnap.exists() && !isSnoozed) showModal();
                });
            } else {
                currentUserId = null; authStatus.textContent = 'Not connected';
                authContainer.classList.remove('hidden'); appContent.classList.add('hidden'); signoutBtn.classList.add('hidden');
            }
        });

        document.getElementById('toggle-form-link').addEventListener('click', e => { e.preventDefault(); document.getElementById('signup-form').classList.toggle('hidden'); document.getElementById('login-form').classList.toggle('hidden'); e.target.textContent = document.getElementById('signup-form').classList.contains('hidden') ? 'Need an account? Sign Up' : 'Already have an account? Login'; });
        document.getElementById('signup-form').addEventListener('submit', e => { e.preventDefault(); createUserWithEmailAndPassword(auth, e.target['signup-email'].value, e.target['signup-password'].value).catch(error => alert(error.message)); });
        document.getElementById('login-form').addEventListener('submit', e => { e.preventDefault(); signInWithEmailAndPassword(auth, e.target['login-email'].value, e.target['login-password'].value).catch(error => alert(error.message)); });
        signoutBtn.addEventListener('click', () => signOut(auth));
        function showModal() { modal.classList.remove('hidden'); }
        function hideModal() { modal.classList.add('hidden'); }
        pulseActionBtn.addEventListener('click', showModal);
        document.getElementById('pulse-form').addEventListener('submit', async (event) => { event.preventDefault(); if (!currentUserId) return; const docId = `${currentUserId}_${getFormattedDate(new Date())}`; await setDoc(doc(db, "pulseCheckins", docId), { steadiness: parseInt(event.target.steadiness.value, 10), presence: parseInt(event.target.presence.value, 10), connection: parseInt(event.target.connection.value, 10), status: 'completed', submittedAt: new Date().toISOString() }); loadPulseData(); hideModal(); });
        document.getElementById('skip-now-btn').addEventListener('click', () => { localStorage.setItem('snoozeUntil', new Date().getTime() + (10 * 60 * 1000)); hideModal(); });
        document.getElementById('skip-today-btn').addEventListener('click', async () => { if (!currentUserId) return; const docId = `${currentUserId}_${getFormattedDate(new Date())}`; await setDoc(doc(db, "pulseCheckins", docId), { status: 'skipped', submittedAt: new Date().toISOString() }); loadPulseData(); hideModal(); });
        
        prevDayBtn.addEventListener('click', () => { reflectionDate.setDate(reflectionDate.getDate() - 1); loadReflectionData(reflectionDate); });
        nextDayBtn.addEventListener('click', () => { reflectionDate.setDate(reflectionDate.getDate() + 1); loadReflectionData(reflectionDate); });
        submitReflectionBtn.addEventListener('click', async () => { if (!currentUserId) return; await setDoc(doc(db, "reflections", `${currentUserId}_${getFormattedDate(reflectionDate)}`), { entryText: reflectionEntry.value, updatedAt: new Date().toISOString() }, { merge: true }); });
        
        function updateChartControls() {
            [chartTodayBtn, chart7dBtn, chart30dBtn].forEach(btn => btn.classList.remove('active'));
            if (currentChartTimeframe === 1) chartTodayBtn.classList.add('active');
            else if (currentChartTimeframe === 7) chart7dBtn.classList.add('active');
            else if (currentChartTimeframe === 30) chart30dBtn.classList.add('active');
            loadPulseData();
        }
        chartTodayBtn.addEventListener('click', () => { currentChartTimeframe = 1; updateChartControls(); });
        chart7dBtn.addEventListener('click', () => { currentChartTimeframe = 7; updateChartControls(); });
        chart30dBtn.addEventListener('click', () => { currentChartTimeframe = 30; updateChartControls(); });

        document.querySelectorAll('.slider-group input[type="range"]').forEach(slider => { const valueSpan = slider.nextElementSibling; slider.addEventListener('input', (e) => { valueSpan.textContent = e.target.value; }); valueSpan.textContent = slider.value; });
    </script>
</body>
</html>

