<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centered - Your Daily Pulse</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Welcome</h1>
        <div class="header-controls">
            <p>Status: <span id="auth-status">Connecting...</span></p>
            <button id="signout-btn" class="hidden">Sign Out</button>
        </div>
    </header>

    <!-- Login/Signup Forms -->
    <div id="auth-container">
        <form id="login-form">
            <h3>Login</h3>
            <input type="email" id="login-email" placeholder="Email" required><br><br>
            <input type="password" id="login-password" placeholder="Password" required><br><br>
            <button type="submit">Login</button>
        </form>
        <form id="signup-form" class="hidden">
            <h3>Sign Up</h3>
            <input type="email" id="signup-email" placeholder="Email" required><br><br>
            <input type="password" id="signup-password" placeholder="Password" required><br><br>
            <button type="submit">Sign Up</button>
        </form>
        <p><a href="#" id="toggle-form-link">Need an account? Sign Up</a></p>
    </div>

    <!-- Main App Content (Dashboard) -->
    <main id="app-content" class="hidden">
        <div id="dashboard">
            <!-- Tile 1: Daily Pulse -->
            <div class="tile full-width" id="pulse-tile">
                <div class="tile-header">
                    <h3>Daily Pulse</h3>
                    <span id="pulse-date"></span>
                </div>
                <div class="tile-content pulse-scores">
                    <div class="score-item">
                        <h4>Steadiness</h4>
                        <p id="steadiness-display">-</p>
                    </div>
                    <div class="score-item">
                        <h4>Presence</h4>
                        <p id="presence-display">-</p>
                    </div>
                    <div class="score-item">
                        <h4>Connection</h4>
                        <p id="connection-display">-</p>
                    </div>
                </div>
                <div class="tile-footer">
                    <button id="pulse-action-btn" class="btn-primary">Do Today's Pulse Check</button>
                </div>
            </div>
            <!-- More tiles will go here later -->
        </div>
    </main>
    
    <!-- Daily Pulse Check-in Modal -->
    <div id="pulse-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <h2 id="modal-title">Daily Pulse Check-in</h2>
            <form id="pulse-form">
                <div class="slider-group">
                    <label for="steadiness">How steady do you feel right now?</label>
                    <input type="range" id="steadiness" name="steadiness" min="0" max="10" value="5">
                    <span class="slider-value">5</span>
                </div>
                <div class="slider-group">
                    <label for="presence">How present were you today?</label>
                    <input type="range" id="presence" name="presence" min="0" max="10" value="5">
                    <span class="slider-value">5</span>
                </div>
                <div class="slider-group">
                    <label for="connection">How connected vs. reactive did you feel?</label>
                    <input type="range" id="connection" name="connection" min="0" max="10" value="5">
                    <span class="slider-value">5</span>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn-primary">Submit</button>
                    <button type="button" id="skip-now-btn">Skip for now</button>
                    <button type="button" id="skip-today-btn">Skip for today</button>
                </div>
            </form>
        </div>
    </div>

    <!-- All JavaScript is now inside this single module script -->
    <script type="module">
        // Import the functions you need from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAkF3nGHsrotcmT1Fen8Kujdlq5JIrqllk",
            authDomain: "centeredos.firebaseapp.com",
            projectId: "centeredos",
            storageBucket: "centeredos.firebasestorage.app",
            messagingSenderId: "129785779353",
            appId: "1:129785779353:web:f0c24b16f5e83e6f5c9408",
            measurementId: "G-7S84S0NHQV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;

        // --- Get all the HTML elements we need ---
        const authStatus = document.getElementById('auth-status');
        const authContainer = document.getElementById('auth-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const toggleFormLink = document.getElementById('toggle-form-link');
        const appContent = document.getElementById('app-content');
        const signoutBtn = document.getElementById('signout-btn');
        const modal = document.getElementById('pulse-modal');
        const pulseForm = document.getElementById('pulse-form');
        const skipNowBtn = document.getElementById('skip-now-btn');
        const skipTodayBtn = document.getElementById('skip-today-btn');
        const pulseActionBtn = document.getElementById('pulse-action-btn');
        const steadinessDisplay = document.getElementById('steadiness-display');
        const presenceDisplay = document.getElementById('presence-display');
        const connectionDisplay = document.getElementById('connection-display');
        const pulseDateEl = document.getElementById('pulse-date');


        // --- Date Formatting ---
        function getFormattedDate(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        pulseDateEl.textContent = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

        // --- UI Update Functions ---
        function updateDashboardUI(pulseData) {
            if (pulseData && pulseData.status === 'completed') {
                steadinessDisplay.textContent = pulseData.steadiness;
                presenceDisplay.textContent = pulseData.presence;
                connectionDisplay.textContent = pulseData.connection;
                pulseActionBtn.textContent = "Today's Pulse Submitted";
                pulseActionBtn.disabled = true;
            } else {
                steadinessDisplay.textContent = '-';
                presenceDisplay.textContent = '-';
                connectionDisplay.textContent = '-';
                pulseActionBtn.textContent = "Do Today's Pulse Check";
                pulseActionBtn.disabled = false;
            }
        }

        // --- Main Data Loading Function ---
        async function loadDailyData() {
            if (!currentUserId) return;

            // Check snooze status first
            const snoozeUntil = localStorage.getItem('snoozeUntil');
            const isSnoozed = snoozeUntil && new Date().getTime() < parseInt(snoozeUntil, 10);

            try {
                const todayDocId = `${currentUserId}_${getFormattedDate()}`;
                const docRef = doc(db, "pulseCheckins", todayDocId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    updateDashboardUI(docSnap.data());
                } else {
                    updateDashboardUI(null); // Reset dashboard UI
                    if (!isSnoozed) {
                        showModal(); // Only show modal if not snoozed and no data exists
                    }
                }
            } catch (error) {
                console.error("Error loading daily data:", error);
            }
        }

        // --- Handle User Authentication State ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                authStatus.textContent = `Connected (${user.email})`;
                authContainer.classList.add('hidden');
                appContent.classList.remove('hidden');
                signoutBtn.classList.remove('hidden');
                loadDailyData();
            } else {
                currentUserId = null;
                authStatus.textContent = 'Not connected';
                authContainer.classList.remove('hidden');
                appContent.classList.add('hidden');
                signoutBtn.classList.add('hidden');
            }
        });
        
        // --- Auth Form Logic ---
        toggleFormLink.addEventListener('click', (e) => {
            e.preventDefault();
            signupForm.classList.toggle('hidden');
            loginForm.classList.toggle('hidden');
            toggleFormLink.textContent = signupForm.classList.contains('hidden') 
                ? 'Need an account? Sign Up' 
                : 'Already have an account? Login';
        });

        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            createUserWithEmailAndPassword(auth, signupForm['signup-email'].value, signupForm['signup-password'].value)
                .catch(error => alert(error.message));
        });
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value)
                .catch(error => alert(error.message));
        });
        signoutBtn.addEventListener('click', () => signOut(auth));

        // --- Modal Logic ---
        function showModal() { modal.classList.remove('hidden'); }
        function hideModal() { modal.classList.add('hidden'); }
        
        pulseActionBtn.addEventListener('click', showModal);

        // --- Pulse Form Handlers ---
        pulseForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!currentUserId) return;
            const docId = `${currentUserId}_${getFormattedDate()}`;
            const pulseData = {
                steadiness: parseInt(pulseForm.steadiness.value, 10),
                presence: parseInt(pulseForm.presence.value, 10),
                connection: parseInt(pulseForm.connection.value, 10),
                status: 'completed',
                submittedAt: new Date().toISOString()
            };
            await setDoc(doc(db, "pulseCheckins", docId), pulseData);
            updateDashboardUI(pulseData); // Update UI immediately
            hideModal();
        });

        skipNowBtn.addEventListener('click', () => {
            const tenMinutesFromNow = new Date().getTime() + (10 * 60 * 1000);
            localStorage.setItem('snoozeUntil', tenMinutesFromNow);
            hideModal();
        });

        skipTodayBtn.addEventListener('click', async () => {
            if (!currentUserId) return;
            const docId = `${currentUserId}_${getFormattedDate()}`;
            const skippedData = {
                status: 'skipped',
                submittedAt: new Date().toISOString()
            };
            await setDoc(doc(db, "pulseCheckins", docId), skippedData);
            updateDashboardUI(skippedData); // Update UI immediately
            hideModal();
        });

        // --- Slider value display logic ---
        document.querySelectorAll('.slider-group input[type="range"]').forEach(slider => {
            const valueSpan = slider.nextElementSibling;
            slider.addEventListener('input', (e) => { valueSpan.textContent = e.target.value; });
            valueSpan.textContent = slider.value; // Set initial value on load
        });
    </script>
</body>
</html>

