<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centered - Your Daily Pulse</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <h1>Welcome</h1>
        <div class="header-controls">
            <p>Status: <span id="auth-status">Connecting...</span></p>
            <button id="signout-btn" class="hidden">Sign Out</button>
        </div>
    </header>

    <div id="auth-container">
        <form id="login-form"><h3>Login</h3><input type="email" id="login-email" placeholder="Email" required><br><br><input type="password" id="login-password" placeholder="Password" required><br><br><button type="submit">Login</button></form><form id="signup-form" class="hidden"><h3>Sign Up</h3><input type="email" id="signup-email" placeholder="Email" required><br><br><input type="password" id="signup-password" placeholder="Password" required><br><br><button type="submit">Sign Up</button></form><p><a href="#" id="toggle-form-link">Need an account? Sign Up</a></p>
    </div>

    <main id="app-content" class="hidden">
        <div id="dashboard">
            <!-- Tile 1: Centeredness Graph -->
            <div class="tile full-width">
                <div class="tile-header">
                    <h3>Centeredness <span id="composite-score-display" class="composite-score">--</span></h3>
                    <div class="chart-controls">
                        <button id="chart-today-btn">Today</button>
                        <button id="chart-7d-btn" class="active">7D</button>
                        <button id="chart-30d-btn">30D</button>
                    </div>
                </div>
                <div class="tile-content chart-container">
                    <canvas id="centeredness-chart"></canvas>
                    <div id="chart-no-data" class="hidden">Not enough data to display</div>
                </div>
                <div class="tile-footer">
                    <button id="pulse-action-btn" class="btn-primary">Do Today's Pulse Check</button>
                </div>
            </div>
            <!-- Tile 2: Daily Reflection -->
            <div class="tile full-width" id="reflection-tile">
                <div class="tile-header">
                    <h3>Daily Reflection</h3>
                    <div class="date-nav">
                        <button id="prev-day-btn">&lt;</button>
                        <span id="reflection-date-display"></span>
                        <button id="next-day-btn">&gt;</button>
                    </div>
                </div>
                <div class="tile-content">
                    <p id="ai-prompt-display">Loading your daily prompt...</p>
                    <textarea id="reflection-entry" placeholder="Write your reflection here..." disabled></textarea>
                </div>
                <div class="tile-footer">
                    <button id="reflection-action-btn">Edit</button>
                </div>
            </div>
            <!-- Tile 3: Habit Tracker -->
            <div class="tile full-width" id="habits-tile">
                <div class="tile-header">
                    <h3>Today's Habits</h3>
                </div>
                <div class="tile-content">
                    <ul id="habit-list"></ul>
                </div>
                <div class="tile-footer">
                    <button id="add-habit-btn" class="btn-primary">Add Habit</button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modals -->
    <div id="pulse-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="pulse-modal-title"><div class="modal-content"><h2 id="pulse-modal-title">Daily Pulse Check-in</h2><form id="pulse-form"><div class="slider-group"><label for="steadiness">How steady do you feel right now?</label><input type="range" id="steadiness" name="steadiness" min="0" max="10" value="5"><span class="slider-value">5</span></div><div class="slider-group"><label for="presence">How present were you today?</label><input type="range" id="presence" name="presence" min="0" max="10" value="5"><span class="slider-value">5</span></div><div class="slider-group"><label for="connection">How connected vs. reactive did you feel?</label><input type="range" id="connection" name="connection" min="0" max="10" value="5"><span class="slider-value">5</span></div><div class="button-group"><button type="submit" class="btn-primary">Submit</button><button type="button" id="skip-now-btn">Skip for now</button><button type="button" id="skip-today-btn">Skip for today</button></div></form></div></div>
    <div id="add-habit-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="habit-modal-title"><div class="modal-content"><h2 id="habit-modal-title">Create a New Habit</h2><form id="add-habit-form"><div class="form-group"><label for="habit-name">Habit Name</label><input type="text" id="habit-name" required></div><div class="form-group"><label for="habit-desc">Description (Optional)</label><textarea id="habit-desc"></textarea></div><div class="button-group"><button type="submit" class="btn-primary">Save Habit</button><button type="button" id="cancel-habit-btn">Cancel</button></div></form></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, orderBy, limit, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAkF3nGHsrotcmT1Fen8Kujdlq5JIrqllk", authDomain: "centeredos.firebaseapp.com", projectId: "centeredos", storageBucket: "centeredos.firebasestorage.app", messagingSenderId: "129785779353", appId: "1:129785779353:web:f0c24b16f5e83e6f5c9408", measurementId: "G-7S84S0NHQV" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;
        let centerednessChart = null;
        let reflectionDate = new Date();
        let currentChartTimeframe = 7; 

        // Get all element references
        const authContainer = document.getElementById('auth-container');
        const appContent = document.getElementById('app-content');
        const signoutBtn = document.getElementById('signout-btn');
        const authStatus = document.getElementById('auth-status');
        const pulseModal = document.getElementById('pulse-modal');
        const addHabitModal = document.getElementById('add-habit-modal');
        const pulseActionBtn = document.getElementById('pulse-action-btn');
        const chartCanvas = document.getElementById('centeredness-chart');
        const chartNoData = document.getElementById('chart-no-data');
        const chartTodayBtn = document.getElementById('chart-today-btn');
        const chart7dBtn = document.getElementById('chart-7d-btn');
        const chart30dBtn = document.getElementById('chart-30d-btn');
        const compositeScoreDisplay = document.getElementById('composite-score-display');
        const aiPromptDisplay = document.getElementById('ai-prompt-display');
        const reflectionEntry = document.getElementById('reflection-entry');
        const reflectionActionBtn = document.getElementById('reflection-action-btn');
        const prevDayBtn = document.getElementById('prev-day-btn');
        const nextDayBtn = document.getElementById('next-day-btn');
        const reflectionDateDisplay = document.getElementById('reflection-date-display');
        const habitList = document.getElementById('habit-list');
        const addHabitBtn = document.getElementById('add-habit-btn');
        const addHabitForm = document.getElementById('add-habit-form');
        const cancelHabitBtn = document.getElementById('cancel-habit-btn');

        function getFormattedDate(date) { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }

        function createOrUpdateChart(chartData, chartType) {
            const ctx = chartCanvas.getContext('2d');
            if (centerednessChart) centerednessChart.destroy();

            let config;
            if (chartType === 'bar') {
                const data = chartData[0] || { steadiness: 0, presence: 0, connection: 0 };
                config = {
                    type: 'bar',
                    data: {
                        labels: ['Steadiness', 'Presence', 'Connection'],
                        datasets: [{
                            label: 'Today\'s Scores',
                            data: [data.steadiness, data.presence, data.connection],
                            backgroundColor: ['rgba(75, 192, 192, 0.2)', 'rgba(255, 159, 64, 0.2)', 'rgba(153, 102, 255, 0.2)'],
                            borderColor: ['rgb(75, 192, 192)', 'rgb(255, 159, 64)', 'rgb(153, 102, 255)'],
                            borderWidth: 1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true, max: 10 } }, plugins: { legend: { display: false } } }
                };
            } else { // THIS IS WHERE THE MISSING BRACE WAS
                config = {
                    type: 'line',
                    data: {
                        labels: chartData.map(d => new Date(d.dateStr + 'T00:00:00').toLocaleDateString('en-us', { month: 'short', day: 'numeric' })),
                        datasets: [
                            { label: 'Steadiness', data: chartData.map(d => d.steadiness), borderColor: 'rgb(75, 192, 192)', tension: 0.1 },
                            { label: 'Presence', data: chartData.map(d => d.presence), borderColor: 'rgb(255, 159, 64)', tension: 0.1 },
                            { label: 'Connection', data: chartData.map(d => d.connection), borderColor: 'rgb(153, 102, 255)', tension: 0.1 }
                        ]
                    },
                    options: { scales: { y: { beginAtZero: true, max: 10 } } }
                };
            }
            centerednessChart = new Chart(ctx, config);
        }

        async function loadPulseData() {
            try {
                if (!currentUserId) return;
                const todayDocSnap = await getDoc(doc(db, "pulseCheckins", `${currentUserId}_${getFormattedDate(new Date())}`));
                if (todayDocSnap.exists() && todayDocSnap.data().status === 'completed') {
                    compositeScoreDisplay.textContent = todayDocSnap.data().compositeScore;
                } else {
                    compositeScoreDisplay.textContent = '--';
                }
                
                let chartData = [];
                const daysToFetch = currentChartTimeframe;
                for (let i = daysToFetch - 1; i >= 0; i--) {
                    const date = new Date(); date.setDate(date.getDate() - i); const dateStr = getFormattedDate(date);
                    const docSnap = await getDoc(doc(db, "pulseCheckins", `${currentUserId}_${dateStr}`));
                    if (docSnap.exists() && docSnap.data().status === 'completed') chartData.push({ dateStr, ...docSnap.data() });
                }

                if (chartData.length === 0) {
                    chartCanvas.classList.add('hidden');
                    chartNoData.classList.remove('hidden');
                } else {
                    chartCanvas.classList.remove('hidden');
                    chartNoData.classList.add('hidden');
                    createOrUpdateChart(chartData, currentChartTimeframe === 1 ? 'bar' : 'line');
                }
                
                if (todayDocSnap.exists()) {
                    pulseActionBtn.textContent = "Today's Pulse Submitted"; pulseActionBtn.disabled = true;
                } else {
                    pulseActionBtn.textContent = "Do Today's Pulse Check"; pulseActionBtn.disabled = false;
                }
            } catch (error) {
                console.error("Error loading pulse data:", error);
            }
        }
        
        async function loadReflectionData(date) {
            try {
                const dateStr = getFormattedDate(date);
                reflectionDateDisplay.textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                nextDayBtn.disabled = dateStr === getFormattedDate(new Date());

                const docSnap = await getDoc(doc(db, "reflections", `${currentUserId}_${dateStr}`));
                
                reflectionEntry.disabled = true;
                reflectionActionBtn.textContent = 'Edit';

                if (docSnap.exists() && docSnap.data().promptText) {
                    aiPromptDisplay.textContent = docSnap.data().promptText;
                    reflectionEntry.value = docSnap.data().entryText || '';
                    reflectionActionBtn.textContent = reflectionEntry.value ? 'Edit' : 'Write';
                    reflectionEntry.classList.remove('hidden');
                    reflectionActionBtn.classList.remove('hidden');
                } else {
                    reflectionEntry.value = '';
                    if (dateStr === getFormattedDate(new Date())) {
                        await generateAIPrompt(date);
                    } else {
                        aiPromptDisplay.textContent = "No reflection recorded for this day.";
                        reflectionEntry.classList.add('hidden');
                        reflectionActionBtn.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error("Error loading reflection data:", error);
            }
        }
        
        async function generateAIPrompt(date) {
            aiPromptDisplay.textContent = "Thinking of a good prompt for you...";
            let pastReflections = [];

            try {
                const reflectionsRef = collection(db, "reflections");
                const q = query(reflectionsRef, where("userId", "==", currentUserId), orderBy("submittedAt", "desc"), limit(5));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(doc => { if (doc.data().entryText) pastReflections.push(doc.data().entryText); });
            } catch (error) {
                console.error("Could not fetch past reflections. Proceeding without them.", error);
            }
            
            const systemPrompt = "You are a highly creative journal assistant. Your main goal is to provide a unique, non-repeating, and insightful CBT-based prompt (under 180 characters). Use a creative, metaphorical, or unexpected angle. Even if the user has no past reflections, generate a completely fresh and varied prompt each day. Avoid generic questions. Do not repeat prompts you have given before.";
            let userQuery = `Please generate a new journal prompt for me. For context, today's date is ${new Date().toDateString()}.`;
            if (pastReflections.length > 0) userQuery += "\n\nHere are my most recent reflections:\n- " + pastReflections.join('\n- ');
            
            console.log('Sending to AI:', userQuery);

            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { 
                    contents: [{ parts: [{ text: userQuery }] }], 
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        temperature: 0.7 
                    }
                };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                
                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("AI Prompt API Error:", JSON.stringify(errorBody, null, 2));
                    throw new Error(`API Error: ${response.status}`);
                }

                const result = await response.json();
                const newPrompt = result.candidates[0].content.parts[0].text;
                aiPromptDisplay.textContent = newPrompt;
                await setDoc(doc(db, "reflections", `${currentUserId}_${getFormattedDate(date)}`), { promptText: newPrompt, entryText: '', userId: currentUserId, submittedAt: new Date(date).toISOString() }, { merge: true });
            } catch (error) {
                console.error("AI Prompt generation failed:", error.message);
                const fallbackPrompt = "What is one thought you've had today that you'd like to look at more closely?";
                aiPromptDisplay.textContent = fallbackPrompt;
                await setDoc(doc(db, "reflections", `${currentUserId}_${getFormattedDate(date)}`), { promptText: fallbackPrompt, entryText: '', userId: currentUserId, submittedAt: new Date(date).toISOString() }, { merge: true });
            } finally {
                reflectionEntry.classList.remove('hidden'); 
                reflectionActionBtn.classList.remove('hidden'); 
                reflectionActionBtn.textContent = 'Write';
            }
        }

        function calculateStreak(habitLogs) {
            let streak = 0;
            const completedDates = new Set();
            habitLogs.forEach(log => {
                if (log.completed) completedDates.add(log.date);
            });

            if (completedDates.size === 0) return 0;
            
            let currentDate = new Date();
            if (!completedDates.has(getFormattedDate(currentDate))) {
                currentDate.setDate(currentDate.getDate() - 1);
            }

            while (completedDates.has(getFormattedDate(currentDate))) {
                streak++;
                currentDate.setDate(currentDate.getDate() - 1);
            }
            return streak;
        }

        async function loadHabitsData() {
            try {
                if (!currentUserId) return;
                habitList.innerHTML = ''; 

                const habitsRef = collection(db, "habits");
                const q = query(habitsRef, where("userId", "==", currentUserId), orderBy("createdAt", "asc"));
                const habitsSnapshot = await getDocs(q);
                
                const allLogsRef = collection(db, "habitLogs");
                const allLogsQuery = query(allLogsRef, where("userId", "==", currentUserId));
                const allLogsSnapshot = await getDocs(allLogsQuery);
                const allLogsByHabit = {};
                allLogsSnapshot.docs.forEach(d => {
                    const log = d.data();
                    if (!allLogsByHabit[log.habitId]) allLogsByHabit[log.habitId] = [];
                    allLogsByHabit[log.habitId].push(log);
                });

                const todayStr = getFormattedDate(new Date());

                habitsSnapshot.forEach(doc => {
                    const habit = doc.data();
                    const habitId = doc.id;
                    const habitLogs = allLogsByHabit[habitId] || [];
                    const streak = calculateStreak(habitLogs);
                    const isCompletedToday = habitLogs.some(log => log.date === todayStr && log.completed);

                    const li = document.createElement('li');
                    li.className = 'habit-item';
                    li.innerHTML = `
                        <label>
                            <input type="checkbox" data-habit-id="${habitId}" ${isCompletedToday ? 'checked' : ''}>
                            <span class="checkmark"></span>
                            <span>${habit.name}</span>
                        </label>
                        <div class="habit-controls">
                            <span class="habit-streak">${streak > 0 ? `ðŸ”¥ ${streak}` : ''}</span>
                            <button class="remove-habit-btn" data-habit-id="${habitId}">&times;</button>
                        </div>
                    `;
                    habitList.appendChild(li);
                });
            } catch (error) {
                console.error("Error loading habits data:", error);
            }
        }

        habitList.addEventListener('click', async (e) => {
            const target = e.target;
            if (target.type === 'checkbox') {
                const habitId = target.dataset.habitId;
                const isChecked = target.checked;
                const logId = `${currentUserId}_${habitId}_${getFormattedDate(new Date())}`;
                
                await setDoc(doc(db, "habitLogs", logId), { userId: currentUserId, habitId, date: getFormattedDate(new Date()), completed: isChecked });
                await loadHabitsData();
            } else if (target.classList.contains('remove-habit-btn')) {
                const habitId = target.dataset.habitId;
                // Removed the confirm() dialog which does not work in this environment
                await deleteDoc(doc(db, "habits", habitId));
                const logsQuery = query(collection(db, "habitLogs"), where("habitId", "==", habitId), where("userId", "==", currentUserId));
                const logsSnapshot = await getDocs(logsQuery);
                logsSnapshot.forEach(logDoc => {
                    deleteDoc(doc(db, "habitLogs", logDoc.id));
                });
                await loadHabitsData();
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                authStatus.textContent = `Connected (${user.email})`;
                authContainer.classList.add('hidden');
                appContent.classList.remove('hidden');
                signoutBtn.classList.remove('hidden');
                reflectionDate = new Date();
                
                Promise.all([
                    loadPulseData(),
                    loadReflectionData(reflectionDate),
                    loadHabitsData()
                ]).then(() => {
                    const isSnoozed = localStorage.getItem('snoozUntil') && new Date().getTime() < parseInt(localStorage.getItem('snoozUntil'), 10);
                    getDoc(doc(db, "pulseCheckins", `${currentUserId}_${getFormattedDate(new Date())}`)).then(docSnap => {
                        if (!docSnap.exists() && !isSnoozed) {
                            showModal(pulseModal);
                        }
                    });
                });

            } else { 
                currentUserId = null;
                authStatus.textContent = 'Not connected';
                authContainer.classList.remove('hidden');
                appContent.classList.add('hidden');
                signoutBtn.classList.add('hidden');
             }
        });
        
        function showModal(modalEl) { modalEl.classList.remove('hidden'); }
        function hideModal(modalEl) { modalEl.classList.add('hidden'); }
        pulseActionBtn.addEventListener('click', () => showModal(pulseModal));
        addHabitBtn.addEventListener('click', () => showModal(addHabitModal));
        cancelHabitBtn.addEventListener('click', () => hideModal(addHabitModal));
        
        addHabitForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const habitName = document.getElementById('habit-name').value;
            const habitDesc = document.getElementById('habit-desc').value;
            if (!currentUserId || !habitName) return;
            await addDoc(collection(db, "habits"), { userId: currentUserId, name: habitName, description: habitDesc, cadence: { type: "daily" }, createdAt: new Date().toISOString() });
            addHabitForm.reset();
            hideModal(addHabitModal);
            await loadHabitsData();
        });

        document.getElementById('pulse-form').addEventListener('submit', async (event) => { 
            event.preventDefault(); 
            if (!currentUserId) return; 
            const steadiness = parseInt(event.target.steadiness.value, 10);
            const presence = parseInt(event.target.presence.value, 10);
            const connection = parseInt(event.target.connection.value, 10);
            const compositeScore = Math.round((steadiness + presence + connection) / 3 * 10) / 10;
            const docId = `${currentUserId}_${getFormattedDate(new Date())}`; 
            await setDoc(doc(db, "pulseCheckins", docId), { steadiness, presence, connection, compositeScore, status: 'completed', submittedAt: new Date().toISOString() }); 
            await loadPulseData(); 
            hideModal(pulseModal); 
        });

        document.getElementById('skip-now-btn').addEventListener('click', () => { localStorage.setItem('snoozUntil', new Date().getTime() + (10 * 60 * 1000)); hideModal(pulseModal); });
        document.getElementById('skip-today-btn').addEventListener('click', async () => { if (!currentUserId) return; const docId = `${currentUserId}_${getFormattedDate(new Date())}`; await setDoc(doc(db, "pulseCheckins", docId), { status: 'skipped', submittedAt: new Date().toISOString() }); await loadPulseData(); hideModal(pulseModal); });
        
        document.getElementById('toggle-form-link').addEventListener('click', e => { e.preventDefault(); document.getElementById('signup-form').classList.toggle('hidden'); document.getElementById('login-form').classList.toggle('hidden'); e.target.textContent = document.getElementById('signup-form').classList.contains('hidden') ? 'Need an account? Sign Up' : 'Already have an account? Login'; });
        document.getElementById('signup-form').addEventListener('submit', e => { e.preventDefault(); createUserWithEmailAndPassword(auth, e.target['signup-email'].value, e.target['signup-password'].value).catch(error => alert(error.message)); });
        document.getElementById('login-form').addEventListener('submit', e => { e.preventDefault(); signInWithEmailAndPassword(auth, e.target['login-email'].value, e.target['login-password'].value).catch(error => alert(error.message)); });
        signoutBtn.addEventListener('click', () => signOut(auth));
        
        prevDayBtn.addEventListener('click', () => { reflectionDate.setDate(reflectionDate.getDate() - 1); loadReflectionData(reflectionDate); });
        nextDayBtn.addEventListener('click', () => { reflectionDate.setDate(reflectionDate.getDate() + 1); loadReflectionData(reflectionDate); });
        
        reflectionActionBtn.addEventListener('click', async () => {
            const isEditing = !reflectionEntry.disabled;
            if (isEditing) {
                if (!currentUserId) return;
                await setDoc(doc(db, "reflections", `${currentUserId}_${getFormattedDate(reflectionDate)}`), { entryText: reflectionEntry.value, updatedAt: new Date().toISOString() }, { merge: true });
                reflectionEntry.disabled = true;
                reflectionActionBtn.textContent = 'Edit';
            } else {
                reflectionEntry.disabled = false;
                reflectionEntry.focus();
                reflectionActionBtn.textContent = 'Save';
            }
        });

        chartTodayBtn.addEventListener('click', () => { currentChartTimeframe = 1; updateChartControls(); });
        chart7dBtn.addEventListener('click', () => { currentChartTimeframe = 7; updateChartControls(); });
        chart30dBtn.addEventListener('click', () => { currentChartTimeframe = 30; updateChartControls(); });

        function updateChartControls() {
            [chartTodayBtn, chart7dBtn, chart30dBtn].forEach(btn => btn.classList.remove('active'));
            if (currentChartTimeframe === 1) chartTodayBtn.classList.add('active');
            else if (currentChartTimeframe === 7) chart7dBtn.classList.add('active');
            else if (currentChartTimeframe === 30) chart30dBtn.classList.add('active');
            loadPulseData();
        }

        document.querySelectorAll('.slider-group input[type="range"]').forEach(slider => { const valueSpan = slider.nextElementSibling; slider.addEventListener('input', (e) => { valueSpan.textContent = e.target.value; }); valueSpan.textContent = slider.value; });
    
    </script>
</body>
</html>

